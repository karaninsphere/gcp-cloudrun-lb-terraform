name: GCP Terraform + Cloud Run Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ai-project-469011
  REGION: asia-south1
  REPO_NAME: docker-repo
  IMAGE_NAME: cloudrun-app
  IMAGE_TAG: v1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1️⃣ Restore GCP service account JSON
      - name: Decode GCP Service Account Key
        run: |
          echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 -d > $HOME/gcp-sa.json

      # 2️⃣ Export credentials for Terraform & gcloud
      - name: Set GCP credentials env
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-sa.json" >> $GITHUB_ENV

      # 3️⃣ Authenticate gcloud
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_B64 }}

      # 4️⃣ Configure Docker for Artifact Registry
      - name: Configure Docker auth
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      # 5️⃣ Terraform Init
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # 6️⃣ Terraform Apply (creates Artifact Registry first)
      - name: Terraform Apply Infra
        working-directory: terraform
        run: terraform apply -auto-approve

      # 7️⃣ Build Docker image
      - name: Build Docker image
        working-directory: app
        run: |
          docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/${IMAGE_NAME}:${IMAGE_TAG} .

      # 8️⃣ Push Docker image
      - name: Push Docker image
        run: |
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/${IMAGE_NAME}:${IMAGE_TAG}

      # 9️⃣ Redeploy Cloud Run with image
      - name: Terraform Apply Cloud Run
        working-directory: terraform
        run: terraform apply -auto-approve
